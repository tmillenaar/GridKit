<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tiled aggregation from points with Dask &mdash; GridKit v0.10.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
    <link rel="canonical" href="https://tmillenaar.github.io/GridKit/versions/v0.10.0/example_gallery/vector_synergy/aggregate_dask.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=294cacf5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Geometry intersections" href="intersect_geometries.html" />
    <link rel="prev" title="Aggregate from points" href="aggregate.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GridKit
          </a>
              <div class="version">
                v0.10.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Example Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#cell-centric">Cell centric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#grid-definitions">Grid definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#raster-operations">Raster operations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#vector-data-interactions">Vector data interactions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="aggregate.html">Aggregate from points</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tiled aggregation from points with Dask</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-input-data">Generate input data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#relate-points-to-grid-cells">Relate points to grid cells</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-the-results">Visualize the results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="intersect_geometries.html">Geometry intersections</a></li>
<li class="toctree-l3"><a class="reference internal" href="interpolate_from_points.html">Interpolate from points</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GridKit</a>
      </nav>

      <div class="wy-nav-content">
  
    <div style="
        background-color: #ffefc2;
        color: #333;
        padding: 1em;
        border-bottom: 2px solid #e6c200;
        font-weight: bold;
        text-align: center;
    ">
      You are viewing an <strong>outdated version</strong> of the documentation (v0.10.0).<br>
      Latest version: <a href="../../../v1.0.0/index.html">v1.0.0</a>
    </div>
  
  
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Example Gallery</a></li>
      <li class="breadcrumb-item active">Tiled aggregation from points with Dask</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/example_gallery/vector_synergy/aggregate_dask.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-example-gallery-vector-synergy-aggregate-dask-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="tiled-aggregation-from-points-with-dask">
<span id="example-aggregate-dask"></span><span id="sphx-glr-example-gallery-vector-synergy-aggregate-dask-py"></span><h1>Tiled aggregation from points with Dask<a class="headerlink" href="#tiled-aggregation-from-points-with-dask" title="Link to this heading"></a></h1>
<p>Group points into grid cells in a tiled manner, using Dask.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>In example <a class="reference internal" href="aggregate.html#example-aggregate"><span class="std std-ref">aggregate.py</span></a> an approach is demonstrated where points
are grouped in cells and averaged per cell.
This example does the same, but in a tiled manner.
Dask is used for the groupby opertaion instead of Pandas.
The main difference is that Dask divides the data into chunks that can be processed independently.
This approach is beneficial if data does not comfortably fit into memory.
A second reason to use this approach is the ability to process different chunks concurrently,
which can provide a significant speedup.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even though parallel processing using Dask can speed up the script,
for a small case like this the overhead is larger than the benefit obtained by parallelizing the operation.</p>
</div>
<p>For a description of the approach used, please refer to <a class="reference internal" href="aggregate.html#example-aggregate"><span class="std std-ref">aggregate.py</span></a>.
This example mostly highlights the differences between the two approaches.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Dask uses the terms ‘chunks’, ‘blocks’ and ‘partitions’.
While there are some nuances, in this example these terms will be used interchangeably.
I will try to stick with ‘chunks’ where I can since this is the general term,
though you will find references to ‘map_blocks()’ for Arrays and ‘map_partitions()’ for DataFrames.</p>
</div>
</section>
<section id="generate-input-data">
<h2>Generate input data<a class="headerlink" href="#generate-input-data" title="Link to this heading"></a></h2>
<p>Let’s start by generating some points.
The data will be a set of points scattered around a circle to create
a dougnut-like shape.
I will first generate the points and the turn them into a Dask Array
using <code class="docutils literal notranslate"><span class="pre">dask.dataframe.from_array</span></code>.
In a scenario where Dask is used because the data is large and memory is limited,
you will likely obtain your dask array in a way that
does not involve first loading the whole array into memory like I do here.
I will print <code class="docutils literal notranslate"><span class="pre">npartitions</span></code> to show the number of chunks the array is divided in
(spoiler, it will be 2000/500 = 4).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.array</span>
<span class="kn">import</span> <span class="nn">dask.dataframe</span>

<span class="kn">from</span> <span class="nn">gridkit.doc_utils</span> <span class="kn">import</span> <span class="n">generate_2d_scatter_doughnut</span><span class="p">,</span> <span class="n">plot_polygons</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">generate_2d_scatter_doughnut</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pnt_x&quot;</span><span class="p">,</span> <span class="s2">&quot;pnt_y&quot;</span><span class="p">],</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">npartitions</span><span class="p">)</span>  <span class="c1"># show the number of chunks</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/tmp/gridkit_docs/v0.10.0/venv/lib/python3.10/site-packages/dask/dataframe/__init__.py:31: FutureWarning:
Dask dataframe query planning is disabled because dask-expr is not installed.

You can install it with `pip install dask[dataframe]` or `conda install dask`.
This will raise in a future version.

  warnings.warn(msg, FutureWarning)
4
</pre></div>
</div>
</section>
<section id="relate-points-to-grid-cells">
<h2>Relate points to grid cells<a class="headerlink" href="#relate-points-to-grid-cells" title="Link to this heading"></a></h2>
<p>Now we can create a grid and determine the cell associated to each point.
No advanced knowledge of Dask is required to follow this example.
It suffices to know that ‘map_blocks’ and ‘map_partitions’ will apply the supplied function to all chunks.
<a class="reference internal" href="../../api/gridkit.index.html#gridkit.index.GridIndex.index_1d" title="gridkit.index.GridIndex.index_1d"><code class="xref py py-meth docutils literal notranslate"><span class="pre">GridIndex.index_1d()</span></code></a> is used because it gives a single number that can be used as
a DataFrame index during the groupby operation.</p>
<p>The column ‘nr_points’ will contain the nr of points per cell once ‘.count()’ is called on the groupy object</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DataFrame only has a ‘pnt_x’ and a ‘pnt_y’ column. which is already the appropriate
shape for <code class="docutils literal notranslate"><span class="pre">grid.cell_at_point</span></code>. However, <code class="docutils literal notranslate"><span class="pre">p[[&quot;pnt_x&quot;,</span> <span class="pre">&quot;pnt_y&quot;]]</span></code> is specified here
to make clear that <code class="docutils literal notranslate"><span class="pre">cell_at_point</span></code> expects this pattern and any other columns in the
DataFrame will need to be ignored for this operation.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gridkit</span> <span class="kn">import</span> <span class="n">GridIndex</span><span class="p">,</span> <span class="n">HexGrid</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">HexGrid</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">grid</span><span class="o">.</span><span class="n">cell_at_point</span><span class="p">(</span><span class="n">p</span><span class="p">[[</span><span class="s2">&quot;pnt_x&quot;</span><span class="p">,</span> <span class="s2">&quot;pnt_y&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">index_1d</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;nr_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Dask DataFrame Structure:
                 pnt_x    pnt_y cell_id nr_points
npartitions=4
0              float64  float64   int64     int64
500                ...      ...     ...       ...
1000               ...      ...     ...       ...
1500               ...      ...     ...       ...
1999               ...      ...     ...       ...
Dask Name: assign, 6 graph layers
</pre></div>
</div>
<p>We can group by the ‘cell_id’. That means points with the same ‘cell_id’ will be combined.
‘count()’ then gets the number of points for every ‘cell_id’.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
<span class="n">occurrences</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<p>Now we have the number of points per cell.
In order to get the Polygon of each corresponding cell,
‘occurrences.index’ can be used, but since it is a 1d index,
it first needs to be converted to a normal index using <a class="reference internal" href="../../api/gridkit.index.html#gridkit.index.GridIndex.from_index_1d" title="gridkit.index.GridIndex.from_index_1d"><code class="xref py py-meth docutils literal notranslate"><span class="pre">GridIndex.from_index_1d()</span></code></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are wondering why we went through all that effort just to end up with a pandas DataFrame in the end,
suffice it to say that the size of the data is significantly reduced after the groupby.
Also, for the sake of the example I will plot the data with matplotlib.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">polygons</span> <span class="o">=</span> <span class="n">occurrences</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="n">grid</span><span class="o">.</span><span class="n">to_shapely</span><span class="p">(</span><span class="n">GridIndex</span><span class="o">.</span><span class="n">from_index_1d</span><span class="p">(</span><span class="nb">id</span><span class="p">)),</span> <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;geoms&quot;</span><span class="p">:</span> <span class="nb">object</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">geoms</span><span class="p">,</span> <span class="n">points_per_cell</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">polygons</span><span class="p">,</span> <span class="n">occurrences</span><span class="o">.</span><span class="n">nr_points</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="visualize-the-results">
<h2>Visualize the results<a class="headerlink" href="#visualize-the-results" title="Link to this heading"></a></h2>
<p>Note how the results are identical to the pandas version.
The input data was the same so this should indeed be the case.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plot_polygons</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">points_per_cell</span><span class="p">,</span> <span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of points per cell&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_aggregate_dask_001.png" srcset="../../_images/sphx_glr_aggregate_dask_001.png" alt="Number of points per cell" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.334 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-example-gallery-vector-synergy-aggregate-dask-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/38f8786a96f33fa721d3497600e2357d/aggregate_dask.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">aggregate_dask.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/5b5ca4e06d8cd9e19cfe42e3418b29ec/aggregate_dask.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">aggregate_dask.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="aggregate.html" class="btn btn-neutral float-left" title="Aggregate from points" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="intersect_geometries.html" class="btn btn-neutral float-right" title="Geometry intersections" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Timo Millenaar.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <style>
    .rst-other-versions li.current a {
      font-weight: bold;
      color: #007bff;
    }
  </style>
  <span class="rst-current-version" data-toggle="rst-current-version">
    Version: v0.10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Versions</dt>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/dev/index.html">dev</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v1.0.0/index.html">v1.0.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.14.1/index.html">v0.14.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.14.0/index.html">v0.14.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.13.0/index.html">v0.13.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.12.1/index.html">v0.12.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.12.0/index.html">v0.12.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.11.1/index.html">v0.11.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.11.0/index.html">v0.11.0</a> 
        </li>
      
        <li class="current">
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.10.0/index.html">v0.10.0</a>   <--
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.2/index.html">v0.9.2</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.1/index.html">v0.9.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.0/index.html">v0.9.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.8.0/index.html">v0.8.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.3/index.html">v0.7.3</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.2/index.html">v0.7.2</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.1/index.html">v0.7.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.0/index.html">v0.7.0</a> 
        </li>
      
    </dl>
    
    <br>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>