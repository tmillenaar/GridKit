<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geometry intersections &mdash; GridKit v0.7.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
    <link rel="canonical" href="https://tmillenaar.github.io/GridKit/versions/v0.7.0/example_gallery/vector_synergy/intersect_geometries.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=05c9169f"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Tiled aggregation from points with Dask" href="aggregate_dask.html" />
    <link rel="prev" title="Aggregate from points" href="aggregate.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GridKit
          </a>
              <div class="version">
                v0.7.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Example Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#cell-centric">Cell centric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#grid-definitions">Grid definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#raster-operations">Raster operations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#vector-data-interactions">Vector data interactions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="aggregate.html">Aggregate from points</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Geometry intersections</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-and-preparing-the-data">Reading and preparing the data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualization">Visualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="aggregate_dask.html">Tiled aggregation from points with Dask</a></li>
<li class="toctree-l3"><a class="reference internal" href="interpolate_from_points.html">Interpolate from points</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GridKit</a>
      </nav>

      <div class="wy-nav-content">
  
    <div style="
        background-color: #ffefc2;
        color: #333;
        padding: 1em;
        border-bottom: 2px solid #e6c200;
        font-weight: bold;
        text-align: center;
    ">
      You are viewing an <strong>outdated version</strong> of the documentation (v0.7.0).<br>
      Latest version: <a href="../../../v1.0.0/index.html">v1.0.0</a>
    </div>
  
  
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Example Gallery</a></li>
      <li class="breadcrumb-item active">Geometry intersections</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/example_gallery/vector_synergy/intersect_geometries.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-example-gallery-vector-synergy-intersect-geometries-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="geometry-intersections">
<span id="sphx-glr-example-gallery-vector-synergy-intersect-geometries-py"></span><h1>Geometry intersections<a class="headerlink" href="#geometry-intersections" title="Link to this heading"></a></h1>
<p>Obtain the cells that intersect with vector geometries.</p>
<p>DEM data source: <a class="reference external" href="https://www.eea.europa.eu/data-and-maps/data/copernicus-land-monitoring-service-eu-dem">https://www.eea.europa.eu/data-and-maps/data/copernicus-land-monitoring-service-eu-dem</a></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Vector geometries can be used to obtain the ID of the intersecting grid cells.
These vector geometries can be either in the form of Shapely (Multi) Geometries or GeoPandas GeoSeries.
A list of geometries can be supplied. This list can contain a mix of geometry types.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>While it is technically possible to stack Multi-Geometries (for example a MultiPolygon of MultiPolygons), this is not good for performance of <code class="docutils literal notranslate"><span class="pre">intersect_geometries</span></code>.
Try to avoid this if possible.</p>
</div>
<p>In this example, GeoPandas is used instead of Shapely, for it also allows us to conveniently read in the vector data.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>GeoPandas is not installed with GridKit by default, while Shapely is.</p>
</div>
</section>
<section id="reading-and-preparing-the-data">
<h2>Reading and preparing the data<a class="headerlink" href="#reading-and-preparing-the-data" title="Link to this heading"></a></h2>
<p>After reading the streams and lakes vector files, they are concatenated into a single GeoDataFrame.
This allows us to obtain the intersecting cells in one function call.
Of course it is also an option to obtain the intersecting cell IDs for the strams and lakes separately and combine them after using <cite>numpy.vstack</cite>.
With that approach it might be worthwhile to call a <cite>numpy.unique</cite> on axis 0 afterwards to remove duplicate IDs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">from</span> <span class="nn">gridkit</span> <span class="kn">import</span> <span class="n">read_raster</span>

<span class="n">rivers</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../tests/data/streams.gpkg&quot;</span><span class="p">)</span>
<span class="n">lakes</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../../tests/data/lakes.gpkg&quot;</span><span class="p">)</span>
<span class="n">dem</span> <span class="o">=</span> <span class="n">read_raster</span><span class="p">(</span><span class="s2">&quot;../../tests/data/alps_dem.tiff&quot;</span><span class="p">)</span>

<span class="n">water_bodies</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">dem</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="n">river_cell_ids</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">intersect_geometries</span><span class="p">(</span><span class="n">water_bodies</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Link to this heading"></a></h2>
<p>For a clear plot, we only need to plot the DEM near the vecor geometries as a backround.
For that reason, the dem is cropped to the extent of the water bodies with a little buffer.
Since <code class="docutils literal notranslate"><span class="pre">intersect_geometries</span></code> does it’s own cropping, cropping the grid before <code class="docutils literal notranslate"><span class="pre">intersect_geometries</span></code> does not increase performance.
A plot showing DEM, the geometries (orange) and the selected cells (red) is then generated as follows:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">dem</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">water_bodies</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">,</span> <span class="n">bounds_crs</span><span class="o">=</span><span class="n">water_bodies</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">buffer_cells</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_plot</span><span class="p">():</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">dem</span><span class="o">.</span><span class="n">mpl_extent</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">dem</span><span class="o">.</span><span class="n">to_shapely</span><span class="p">(</span><span class="n">river_cell_ids</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">water_bodies</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">generate_plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_intersect_geometries_001.png" srcset="../../_images/sphx_glr_intersect_geometries_001.png" alt="intersect geometries" class = "sphx-glr-single-img"/><p>A zoom-in of a section of the plot allows us to see more clearly what cells are selected.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">generate_plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">30040</span><span class="p">,</span> <span class="mi">30160</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">167230</span><span class="p">,</span> <span class="mi">167325</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_intersect_geometries_002.png" srcset="../../_images/sphx_glr_intersect_geometries_002.png" alt="intersect geometries" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 5.311 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-example-gallery-vector-synergy-intersect-geometries-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4f897756f108f82a8f2e7e9c3eb00ccd/intersect_geometries.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">intersect_geometries.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4facd33fff251a2787651dca9f4d4c29/intersect_geometries.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">intersect_geometries.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="aggregate.html" class="btn btn-neutral float-left" title="Aggregate from points" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="aggregate_dask.html" class="btn btn-neutral float-right" title="Tiled aggregation from points with Dask" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Timo Millenaar.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <style>
    .rst-other-versions li.current a {
      font-weight: bold;
      color: #007bff;
    }
  </style>
  <span class="rst-current-version" data-toggle="rst-current-version">
    Version: v0.7.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Versions</dt>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/dev/index.html">dev</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v1.0.0/index.html">v1.0.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.14.1/index.html">v0.14.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.14.0/index.html">v0.14.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.13.0/index.html">v0.13.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.12.1/index.html">v0.12.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.12.0/index.html">v0.12.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.11.1/index.html">v0.11.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.11.0/index.html">v0.11.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.10.0/index.html">v0.10.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.2/index.html">v0.9.2</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.1/index.html">v0.9.1</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.9.0/index.html">v0.9.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.8.0/index.html">v0.8.0</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.3/index.html">v0.7.3</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.2/index.html">v0.7.2</a> 
        </li>
      
        <li >
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.1/index.html">v0.7.1</a> 
        </li>
      
        <li class="current">
          <a href="https://tmillenaar.github.io/GridKit/versions/v0.7.0/index.html">v0.7.0</a>   <--
        </li>
      
    </dl>
    
    <br>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>